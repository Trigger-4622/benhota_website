<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Encrypt 3D Model ‚Äî Utility</title>
	<style>
		* { margin: 0; padding: 0; box-sizing: border-box; }
		body { font-family: 'Segoe UI', sans-serif; background: #0a0a0f; color: #e8e8ed; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 2rem; }
		.card { background: #12121a; border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 2.5rem; max-width: 560px; width: 100%; }
		h1 { font-size: 1.3rem; margin-bottom: 0.3rem; }
		p.sub { color: rgba(255,255,255,0.45); font-size: 0.8rem; margin-bottom: 1.5rem; line-height: 1.5; }
		label { display: block; font-size: 0.78rem; color: rgba(255,255,255,0.55); margin-bottom: 0.4rem; font-weight: 500; }
		.file-hint { font-size: 0.7rem; color: rgba(255,255,255,0.3); margin-bottom: 0.5rem; line-height: 1.4; }
		input[type="file"], input[type="password"], input[type="text"] {
			width: 100%; padding: 0.7rem; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1);
			border-radius: 8px; color: #e8e8ed; font-family: 'Consolas', monospace; font-size: 0.85rem; margin-bottom: 0.5rem; outline: none;
		}
		input:focus { border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,0.3); }
		.file-summary { font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-bottom: 1rem; min-height: 1.2em; font-family: 'Consolas', monospace; }
		.file-summary .obj { color: #6366f1; }
		.file-summary .mtl { color: #8b5cf6; }
		.file-summary .tex { color: #06b6d4; }
		.file-summary .glb { color: #22c55e; }
		button { width: 100%; padding: 0.8rem; background: linear-gradient(135deg, #6366f1, #8b5cf6); border: none; border-radius: 8px; color: #fff; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: 0.2s; }
		button:hover { box-shadow: 0 4px 20px rgba(99,102,241,0.4); transform: translateY(-1px); }
		button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
		.status { margin-top: 1rem; font-size: 0.8rem; color: rgba(255,255,255,0.5); min-height: 1.2em; }
		.status.ok { color: #22c55e; }
		.status.err { color: #ef4444; }
		.note { font-size: 0.68rem; color: rgba(255,255,255,0.3); margin-top: 1.5rem; line-height: 1.5; }
		code { background: rgba(99,102,241,0.12); padding: 0.15em 0.4em; border-radius: 4px; font-size: 0.85em; }
		.sep { border: none; border-top: 1px solid rgba(255,255,255,0.06); margin: 1.5rem 0; }
		.progress-wrap { width: 100%; height: 4px; background: rgba(255,255,255,0.06); border-radius: 2px; margin-top: 0.75rem; overflow: hidden; display: none; }
		.progress-bar { height: 100%; background: linear-gradient(90deg, #6366f1, #8b5cf6); border-radius: 2px; width: 0%; transition: width 0.3s; }
	</style>
</head>
<body>
	<div class="card">
		<h1>üîê Encrypt 3D Model</h1>
		<p class="sub">Encrypt a 3D model with AES-256-GCM. Supports single <code>.glb</code> files <strong>or</strong> <code>.obj</code> + <code>.mtl</code> + textures bundled together.</p>

		<label>Model Files</label>
		<p class="file-hint">Select a single .glb ‚Äî OR ‚Äî select .obj + .mtl + all texture files together</p>
		<input type="file" id="model-files" multiple accept=".glb,.gltf,.obj,.mtl,.jpg,.jpeg,.png,.bmp,.tga" />
		<div class="file-summary" id="file-summary"></div>

		<label>Encryption Password</label>
		<input type="password" id="enc-password" placeholder="Same password users will enter to view" />

		<button id="encrypt-btn" style="margin-top:0.5rem;">Encrypt &amp; Download</button>
		<div class="progress-wrap" id="progress-wrap">
			<div class="progress-bar" id="progress-bar"></div>
		</div>
		<div class="status" id="status"></div>

		<hr class="sep" />

		<h1 style="font-size:1.1rem; margin-bottom:0.3rem;">üîì Verify Encrypted File</h1>
		<p class="sub" style="margin-bottom:1rem;">Test that your <code>house.enc</code> can be decrypted before deploying.</p>

		<label>Encrypted File (house.enc)</label>
		<input type="file" id="verify-file" accept=".enc" />

		<label>Decryption Password</label>
		<input type="password" id="verify-password" placeholder="Same password used to encrypt" />

		<button id="verify-btn" style="background:linear-gradient(135deg, #22c55e, #16a34a);">Verify Decryption</button>
		<div class="status" id="verify-status"></div>

		<p class="note">
			<strong>How it works:</strong><br/>
			1. Choose your model files and set a password<br/>
			2. Click "Encrypt &amp; Download" ‚Üí save as <code>house.enc</code><br/>
			3. Use "Verify" below to confirm it decrypts correctly<br/>
			4. Put <code>house.enc</code> in the <code>/models/</code> folder of your site<br/><br/>
			For OBJ models: select the <code>.obj</code>, <code>.mtl</code>, and <strong>all</strong> texture files at once.
			They'll be bundled into a single encrypted file automatically.
		</p>
	</div>

	<script>
		// ‚îÄ‚îÄ Bundle format ‚îÄ‚îÄ
		// Magic: "BNDL" (4 bytes) + uint32LE file_count
		// Per file: uint16LE name_len + name_bytes + uint32LE data_len + data_bytes
		// Single GLB files are stored as-is (no bundle header) for backward compat.

		var SALT_LEN = 16;
		var IV_LEN = 12;
		var ITERATIONS = 100000;

		function formatSize(bytes) {
			if (bytes < 1024) return bytes + ' B';
			if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
			return (bytes / 1048576).toFixed(1) + ' MB';
		}

		// ‚îÄ‚îÄ File summary on selection ‚îÄ‚îÄ
		document.getElementById('model-files').addEventListener('change', function() {
			var files = this.files;
			var summary = document.getElementById('file-summary');
			if (!files.length) { summary.innerHTML = ''; return; }

			var obj = 0, mtl = 0, glb = 0, tex = 0, totalSize = 0;
			for (var i = 0; i < files.length; i++) {
				var name = files[i].name.toLowerCase();
				totalSize += files[i].size;
				if (name.endsWith('.obj')) obj++;
				else if (name.endsWith('.mtl')) mtl++;
				else if (name.endsWith('.glb') || name.endsWith('.gltf')) glb++;
				else tex++;
			}

			var parts = [];
			if (glb) parts.push('<span class="glb">' + glb + ' GLB</span>');
			if (obj) parts.push('<span class="obj">' + obj + ' OBJ</span>');
			if (mtl) parts.push('<span class="mtl">' + mtl + ' MTL</span>');
			if (tex) parts.push('<span class="tex">' + tex + ' texture' + (tex !== 1 ? 's' : '') + '</span>');

			summary.innerHTML = files.length + ' file' + (files.length !== 1 ? 's' : '') + ' (' + parts.join(', ') + ') ‚Äî ' + formatSize(totalSize);
		});

		// ‚îÄ‚îÄ Crypto ‚îÄ‚îÄ
		async function deriveKey(password, salt, usage) {
			var enc = new TextEncoder();
			var baseKey = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
			return crypto.subtle.deriveKey(
				{ name: 'PBKDF2', salt: salt, iterations: ITERATIONS, hash: 'SHA-256' },
				baseKey,
				{ name: 'AES-GCM', length: 256 },
				false,
				[usage]
			);
		}

		// ‚îÄ‚îÄ Build bundle from multiple files ‚îÄ‚îÄ
		async function buildBundle(fileList) {
			// Single GLB ‚Üí raw bytes (backward compatible, no bundle header)
			if (fileList.length === 1) {
				var singleName = fileList[0].name.toLowerCase();
				if (singleName.endsWith('.glb') || singleName.endsWith('.gltf')) {
					return await fileList[0].arrayBuffer();
				}
			}

			// Multi-file bundle
			var entries = [];
			var totalDataSize = 4 + 4; // magic + count

			for (var i = 0; i < fileList.length; i++) {
				var nameBytes = new TextEncoder().encode(fileList[i].name);
				var data = new Uint8Array(await fileList[i].arrayBuffer());
				entries.push({ nameBytes: nameBytes, data: data });
				totalDataSize += 2 + nameBytes.length + 4 + data.length;
			}

			var bundle = new Uint8Array(totalDataSize);
			var view = new DataView(bundle.buffer);
			var offset = 0;

			// Magic: "BNDL"
			bundle[0] = 0x42; bundle[1] = 0x4E; bundle[2] = 0x44; bundle[3] = 0x4C;
			offset = 4;

			// File count
			view.setUint32(offset, entries.length, true);
			offset += 4;

			for (var i = 0; i < entries.length; i++) {
				var e = entries[i];
				view.setUint16(offset, e.nameBytes.length, true);
				offset += 2;
				bundle.set(e.nameBytes, offset);
				offset += e.nameBytes.length;
				view.setUint32(offset, e.data.length, true);
				offset += 4;
				bundle.set(e.data, offset);
				offset += e.data.length;
			}

			return bundle.buffer;
		}

		// ‚îÄ‚îÄ Encrypt button ‚îÄ‚îÄ
		document.getElementById('encrypt-btn').addEventListener('click', async function() {
			var fileInput = document.getElementById('model-files');
			var password = document.getElementById('enc-password').value;
			var status = document.getElementById('status');
			var progressWrap = document.getElementById('progress-wrap');
			var progressBar = document.getElementById('progress-bar');

			if (!fileInput.files.length) { status.className = 'status err'; status.textContent = 'Please select model files.'; return; }
			if (!password) { status.className = 'status err'; status.textContent = 'Please enter a password.'; return; }

			status.className = 'status';
			status.textContent = 'Reading files...';
			progressWrap.style.display = 'block';
			progressBar.style.width = '10%';
			this.disabled = true;

			try {
				await new Promise(function(r) { setTimeout(r, 50); });

				var bundleBuf = await buildBundle(fileInput.files);
				status.textContent = 'Bundled ' + formatSize(bundleBuf.byteLength) + '. Encrypting...';
				progressBar.style.width = '50%';
				await new Promise(function(r) { setTimeout(r, 50); });

				var salt = crypto.getRandomValues(new Uint8Array(SALT_LEN));
				var iv = crypto.getRandomValues(new Uint8Array(IV_LEN));
				var key = await deriveKey(password, salt, 'encrypt');
				var encrypted = await crypto.subtle.encrypt({ name: 'AES-GCM', iv: iv }, key, bundleBuf);

				progressBar.style.width = '90%';

				var combined = new Uint8Array(SALT_LEN + IV_LEN + encrypted.byteLength);
				combined.set(salt, 0);
				combined.set(iv, SALT_LEN);
				combined.set(new Uint8Array(encrypted), SALT_LEN + IV_LEN);

				var blob = new Blob([combined], { type: 'application/octet-stream' });
				var url = URL.createObjectURL(blob);
				var a = document.createElement('a');
				a.href = url; a.download = 'house.enc'; a.click();
				URL.revokeObjectURL(url);

				progressBar.style.width = '100%';
				status.className = 'status ok';
				status.textContent = '‚úì Encrypted! Save as models/house.enc (' + formatSize(combined.byteLength) + ')';
			} catch (err) {
				status.className = 'status err';
				status.textContent = 'Error: ' + err.message;
			}

			this.disabled = false;
			setTimeout(function() { progressWrap.style.display = 'none'; }, 2000);
		});

		// ‚îÄ‚îÄ Verify decryption ‚îÄ‚îÄ
		document.getElementById('verify-btn').addEventListener('click', async function() {
			var fileInput = document.getElementById('verify-file');
			var password = document.getElementById('verify-password').value;
			var status = document.getElementById('verify-status');

			if (!fileInput.files.length) { status.className = 'status err'; status.textContent = 'Select a .enc file.'; return; }
			if (!password) { status.className = 'status err'; status.textContent = 'Enter the password.'; return; }

			status.className = 'status'; status.textContent = 'Decrypting...';
			this.disabled = true;

			try {
				var encBuf = await fileInput.files[0].arrayBuffer();
				status.textContent = 'File loaded (' + formatSize(encBuf.byteLength) + '). Deriving key...';
				await new Promise(function(r) { setTimeout(r, 50); });

				var data = new Uint8Array(encBuf);
				var salt = data.slice(0, SALT_LEN);
				var iv = data.slice(SALT_LEN, SALT_LEN + IV_LEN);
				var ciphertext = data.slice(SALT_LEN + IV_LEN);

				var key = await deriveKey(password, salt, 'decrypt');
				status.textContent = 'Key derived. Decrypting ' + formatSize(ciphertext.byteLength) + '...';
				await new Promise(function(r) { setTimeout(r, 50); });

				var decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv: iv }, key, ciphertext);

				// Detect format
				var decBytes = new Uint8Array(decrypted);
				var isBndl = decBytes[0] === 0x42 && decBytes[1] === 0x4E && decBytes[2] === 0x44 && decBytes[3] === 0x4C;

				if (isBndl) {
					var view = new DataView(decrypted);
					var fc = view.getUint32(4, true);
					var names = [];
					var off = 8;
					for (var i = 0; i < fc; i++) {
						var nl = view.getUint16(off, true); off += 2;
						var nm = new TextDecoder().decode(decBytes.slice(off, off + nl)); off += nl;
						var dl = view.getUint32(off, true); off += 4;
						names.push(nm + ' (' + formatSize(dl) + ')');
						off += dl;
					}
					status.className = 'status ok';
					status.textContent = '‚úì Decryption OK! Bundle with ' + fc + ' files: ' + names.join(', ');
				} else {
					status.className = 'status ok';
					status.textContent = '‚úì Decryption OK! Single file, ' + formatSize(decrypted.byteLength) + ' decrypted.';
				}
			} catch (err) {
				if (err.name === 'OperationError') {
					status.className = 'status err';
					status.textContent = '‚úó Wrong password ‚Äî AES-GCM authentication failed.';
				} else {
					status.className = 'status err';
					status.textContent = '‚úó Error: ' + err.message;
				}
			}
			this.disabled = false;
		});
	</script>
</body>
</html>
